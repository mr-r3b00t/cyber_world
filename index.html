<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Cyber Attacks Live</title>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;font-family:Arial,sans-serif;}
    #globe-container{width:100vw;height:100vh;position:fixed;}
    #title{position:fixed;top:20px;left:50%;transform:translateX(-50%);color:#00ffcc;font-size:3rem;
      text-shadow:0 0 30px #00ffcc;z-index:10;pointer-events:none;}
    #stats{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.8);padding:15px 25px;
      border:2px solid #00ff88;border-radius:12px;color:#00ffcc;z-index:10;}
    #count{font-weight:bold;color:#00ffff;font-size:1.6rem;}
    #controls{position:fixed;bottom:20px;right:20px;z-index:10;display:flex;gap:10px;}
    button{background:#001a17;border:2px solid #00ffcc;color:#00ffcc;padding:10px 18px;
      border-radius:10px;font-weight:bold;cursor:pointer;}
    button:hover{background:#00332a;}
  </style>
</head>
<body>

  <div id="title">GLOBAL CYBER ATTACKS LIVE</div>
  <div id="stats">
    <div>Attacks: <span id="count">0</span></div>
    <div id="status">Loading…</div>
  </div>

  <div id="controls">
    <button id="playPause">Pause</button>
    <button id="reset">Reset View</button>
    <button id="restart">Restart Attacks</button>
    <button id="test">Test Attack</button>
  </div>

  <div id="globe-container"></div>

  <script>
    const globe = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .atmosphereColor('#00ffff')
      .atmosphereAltitude(0.18)
      (document.getElementById('globe-container'));

    let allAttacks = [];
    let displayed = [];
    let playing = true;

    // Updated GeoIP using ipinfo.io (reliable, free)
    async function getLatLng(ip) {
      try {
        const res = await fetch(`https://ipinfo.io/${ip}/geo`);
        const d = await res.json();
        if (d.loc) {
          const [lat, lng] = d.loc.split(',').map(Number);
          return { lat, lng };
        }
      } catch(e) { console.error('GeoIP error for ' + ip, e); }
      // Fallback random location
      return { lat: Math.random()*180-90, lng: Math.random()*360-180 };
    }

    async function loadAttacks() {
      try {
        const resp = await fetch('https://mr-r3b00t.github.io/cyber_world/honeypot.json?t=' + Date.now());
        const ips = await resp.json();                   // ← pure array of IPs
        allAttacks = [];

        document.getElementById('status').textContent = `Geolocating ${ips.length} IPs…`;

        for (const ip of ips.slice(0, 50)) {             // Reduced to 50 to avoid rate limits and improve speed
          const geo = await getLatLng(ip);
          allAttacks.push({
            startLat: geo.lat + rand(-3,3),
            startLng: geo.lng + rand(-5,5),
            endLat: 50.11,      // Europe honeypot
            endLng: 8.68,
            color: [['red', 'white'], ['white', 'red']][Math.round(Math.random())],
            stroke: 1.5 + Math.random()*1.5,
            dashAnimateTime: 1500 + Math.random()*2000
          });
        }

        displayed = allAttacks.slice();
        document.getElementById('count').textContent = displayed.length;
        document.getElementById('status').textContent = 'LIVE';
        render();

      } catch(e) {
        document.getElementById('status').textContent = 'Error loading data';
        console.error(e);
      }
    }

    function render() {
      const visible = displayed.slice(-600);
      globe.arcsData(visible)
        .arcColor('color').arcStroke('stroke')
        .arcDashLength(0.9).arcDashGap(4)
        .arcDashInitialGap(() => Math.random()*5)
        .arcDashAnimateTime('dashAnimateTime')
        .arcAltitude(0.4);  // Make arcs curved and more visible

      const points = visible.flatMap(a => [
        {lat: a.startLat, lng: a.startLng, size: 0.6, color: 'red'},
        {lat: a.endLat, lng: a.endLng, size: 1.0, color: 'white'}
      ]);
      globe.pointsData(points).pointAltitude(0.02).pointRadius('size').pointColor('color');
    }

    function rand(min,max){return Math.random()*(max-min)+min;}

    // Controls
    document.getElementById('playPause').onclick = function() {
      playing = !playing;
      globe.controls().autoRotate = playing;
      this.textContent = playing ? 'Pause' : 'Play';
    };

    document.getElementById('reset').onclick = () => {
      globe.pointOfView({lat:20,lng:0,altitude:2.5}, 1000);
    };

    document.getElementById('restart').onclick = () => {
      displayed = [];
      document.getElementById('count').textContent = '0';
      document.getElementById('status').textContent = 'Replaying…';
      let i = 0;
      const timer = setInterval(() => {
        if (i >= allAttacks.length) {
          clearInterval(timer);
          document.getElementById('status').textContent = 'LIVE';
          return;
        }
        displayed.push(allAttacks[i++]);
        document.getElementById('count').textContent = displayed.length;
        render();
      }, 120);
    };

    // New Test Button: Fires a single random attack event
    document.getElementById('test').onclick = () => {
      const testGeo = { lat: Math.random()*180-90, lng: Math.random()*360-180 };
      const testAttack = {
        startLat: testGeo.lat + rand(-3,3),
        startLng: testGeo.lng + rand(-5,5),
        endLat: 50.11,
        endLng: 8.68,
        color: [['red', 'white'], ['white', 'red']][Math.round(Math.random())],
        stroke: 1.5 + Math.random()*1.5,
        dashAnimateTime: 1500 + Math.random()*2000
      };
      displayed.push(testAttack);
      document.getElementById('count').textContent = displayed.length;
      render();
      document.getElementById('status').textContent = 'Test attack fired!';
    };

    // Start
    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.5;
    loadAttacks();
    setInterval(loadAttacks, 300000); // refresh every 5 min
  </script>
</body>
</html>
