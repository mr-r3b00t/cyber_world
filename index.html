<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Global Cyber Attacks Live • GreedyBear Honeynet</title>
  <script src="https://unpkg.com/globe.gl"></script>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;font-family:'Segoe UI',sans-serif;}
    #globe-container{position:fixed;top:0;left:0;right:0;bottom:0;width:100vw;height:100vh;}
    canvas{display:block;width:100%!important;height:100%!important;}

    #title{position:fixed;top:20px;left:50%;transform:translateX(-50%);color:#00ffcc;font-size:3rem;font-weight:700;
      text-shadow:0 0 30px #00ffcc;letter-spacing:4px;z-index:10;pointer-events:none;}

    #stats{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,0.85);padding:18px 32px;border-radius:16px;
      border:2px solid #00ff88;color:#00ffcc;z-index:10;font-size:1.3rem;box-shadow:0 0 30px rgba(0,255,136,0.4);backdrop-filter:blur(8px);}
    #count{font-weight:bold;color:#00ffff;font-size:1.6rem;}

    #controls{position:fixed;bottom:20px;right:20px;z-index:10;display:flex;gap:12px;flex-wrap:wrap;}
    button{background:rgba(0,255,200,0.15);border:2px solid #00ffcc;color:#00ffcc;padding:12px 20px;border-radius:12px;
      font-size:1rem;font-weight:bold;cursor:pointer;transition:all 0.3s;box-shadow:0 0 20px rgba(0,255,200,0.3);}
    button:hover{background:rgba(0,255,200,0.3);transform:scale(1.05);}
    button:active{transform:scale(0.98);}
    button.pause, button.replay{border-color:#ff6600;color:#ff6600;}
    button.pause:hover, button.replay:hover{background:rgba(255,102,0,0.3);}
    button:disabled{opacity:0.5;cursor:not-allowed;}
  </style>
</head>
<body>

  <div id="title">GLOBAL CYBER ATTACKS LIVE</div>

  <div id="stats">
    <div>Attacks visualized: <span id="count">0</span></div>
    <div>Source: GreedyBear Honeynet</div>
    <div id="status">Loading data…</div>
  </div>

  <div id="controls">
    <button id="playPause">Pause Rotation</button>
    <button id="reset">Reset View</button>
    <button id="refresh">Refresh Data</button>
    <button id="restart">Restart Attacks</button>
  </div>

  <div id="globe-container"></div>

  <script>
    const globe = Globe()
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .atmosphereColor('#00ffff')
      .atmosphereAltitude(0.18)
      .pointOfView({ lat: 20, lng: 10, altitude: 2.8 })
      (document.getElementById('globe-container'));

    let allAttacks = [];           // Full dataset (with timestamp if available)
    let currentAttacks = [];        // Currently visible attacks
    let isPaused = false;
    let replayInterval = null;
    const geoCache = new Map();

    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('count');
    const playPauseBtn = document.getElementById('playPause');
    const restartBtn = document.getElementById('restart');

    // === BUTTONS ===
    playPauseBtn.addEventListener('click', () => {
      isPaused = !isPaused;
      globe.controls().autoRotate = !isPaused;
      playPauseBtn.textContent = isPaused ? 'Play Rotation' : 'Pause Rotation';
      playPauseBtn.classList.toggle('pause', isPaused);
    });

    document.getElementById('reset').addEventListener('click', () => {
      globe.pointOfView({ lat: 20, lng: 10, altitude: 2.8 }, 1500);
    });

    document.getElementById('refresh').addEventListener('click', () => {
      statusEl.textContent = 'Refreshing data…';
      loadAttacks();
    });

    restartBtn.addEventListener('click', () => {
      if (replayInterval) clearInterval(replayInterval);
      currentAttacks = [];
      countEl.textContent = '0';
      statusEl.textContent = 'Replaying from oldest attack…';
      restartBtn.disabled = true;
      restartBtn.textContent = 'Replaying…';

      // Sort by timestamp if available, otherwise just use array order
      const sorted = allAttacks.slice().sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0));

      let i = 0;
      replayInterval = setInterval(() => {
        if (i >= sorted.length) {
          clearInterval(replayInterval);
          replayInterval = null;
          statusEl.textContent = `Replay finished • ${new Date().toLocaleTimeString()}`;
          restartBtn.disabled = false;
          restartBtn.textContent = 'Restart Attacks';
          return;
        }
        currentAttacks.push(sorted[i]);
        countEl.textContent = currentAttacks.length.toLocaleString();
        render();
        i++;
      }, 150); // ~150ms per attack = cinematic feel
    });

    // === GEO + DATA ===
    async function geolocate(ip) {
      if (geoCache.has(ip)) return geoCache.get(ip);
      try {
        const res = await fetch(`https://ipapi.co/${ip}/json/`);
        const d = await res.json();
        if (d.latitude && d.longitude) {
          const loc = { lat: d.latitude, lng: d.longitude };
          geoCache.set(ip, loc);
          return loc;
        }
      } catch (e) {}
      return { lat: (Math.random()-0.5)*180, lng: (Math.random()-0.5)*360 };
    }

    async function loadAttacks() {
      try {
        const resp = await fetch('https://mr-r3b00t.github.io/cyber_world/honeypot.json?t=' + Date.now());
        if (!resp.ok) throw new Error('Not found');
        const data = await resp.json();

        allAttacks = [];
        const ips = new Set();

        // Extract IPs from all tables
        ['High-Impact IPs', 'Recent New Threats', 'High Login Attempt IPs'].forEach(key => {
          if (data[key]) {
            data[key].forEach(row => {
              const ip = row['IP Address'] || row['IP'] || row;
              if (ip && typeof ip === 'string') ips.add(ip.trim());
            });
          }
        });

        statusEl.textContent = `Geolocating ${ips.size} unique IPs…`;

        for (const ip of ips) {
          const geo = await geolocate(ip);
          allAttacks.push({
            startLat: geo.lat + rand(-2,2),
            startLng: geo.lng + rand(-4,4),
            endLat: 50.11,
            endLng: 8.68,
            color: Math.random() < 0.15 ? ['#ff0066','#ff3366'] : ['#00ffcc','#00ffff'],
            stroke: 1.5 + Math.random()*2,
            dashAnimateTime: 1800 + Math.random()*2200,
            timestamp: Date.now() // fallback timestamp
          });
        }

        // Show all immediately on first load
        currentAttacks = allAttacks.slice();
        countEl.textContent = currentAttacks.length.toLocaleString();
        statusEl.textContent = `Live • ${new Date().toLocaleTimeString()}`;
        render();

      } catch (e) {
        statusEl.innerHTML = `<span style="color:#ff0066">Error: ${e.message}</span>`;
      }
    }

    function render() {
      const visible = currentAttacks.slice(-800);
      globe.arcsData(visible)
        .arcColor('color').arcStroke('stroke')
        .arcDashLength(0.9).arcDashGap(4)
        .arcDashInitialGap(() => Math.random()*5)
        .arcDashAnimateTime('dashAnimateTime');

      const points = visible.flatMap(a => [
        { lat: a.startLat, lng: a.startLng, size: 0.6, color: '#ff3366' },
        { lat: a.endLat,   lng: a.endLng,   size: 1.1, color: '#00ffff' }
      ]);
      globe.pointsData(points)
        .pointAltitude(0.018).pointRadius('size').pointColor('color');
    }

    function rand(min,max){return Math.random()*(max-min)+min;}

    globe.controls().autoRotate = true;
    globe.controls().autoRotateSpeed = 0.5;

    loadAttacks();
    setInterval(loadAttacks, 180000); // refresh every 3 mins
  </script>
</body>
</html>
