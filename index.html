# save as: download_greedybear.py
# run with: python download_greedybear.py

import json
import requests
from datetime import datetime

URL = "https://greedybear.honeynet.org/feeds?page=1"

print("Downloading latest attacks from GreedyBear...")

try:
    # GreedyBear loads the data via JavaScript → we fetch the exact API used by the site
    # Inspect → Network tab shows it calls this endpoint directly:
    api_url = "https://greedybear.honeynet.org/api/v1/attacks/recent/?page=1&page_size=5000"

    headers = {
        "User-Agent": "Mozilla/5.0 (compatible; GreedyBear-Downloader/1.0)",
        "Accept": "application/json"
    }

    response = requests.get(api_url, headers=headers, timeout=20)
    response.raise_for_status()
    data = response.json()

    attacks = data.get("results", [])  # GreedyBear uses pagination → "results" key

    # Convert to the simple format our map expects
    # (you can keep more fields if you want — the map only needs src_lat/src_lon)
    simple_attacks = []
    for attack in attacks:
        src_ip = attack.get("source_ip")
        if not src_ip:
            continue

        # GreedyBear already includes geolocation!
        lat = attack.get("source_latitude")
        lon = attack.get("source_longitude")

        if lat is not None and lon is not None:
            simple_attacks.append({
                "src_lat": round(float(lat), 5),
                "src_lon": round(float(lon), 5),
                # Optional: keep extra info for future use
                "ip": src_ip,
                "timestamp": attack.get("timestamp"),
                "attack_type": attack.get("attack_type") or attack.get("type")
            })

    # Save to file
    with open("honeypot.json", "w", encoding="utf-8") as f:
        json.dump(simple_attacks, f, indent=2)

    print(f"Success! Downloaded {len(simple_attacks):,} attacks → honeypot.json")
    print(f"Last attack: {simple_attacks[0]['timestamp'] if simple_attacks else 'N/A'}")

except Exception as e:
    print("Error:", e)
    print("Tip: The site may have changed — open the page in browser, press F12 → Network → look for a request returning JSON and update api_url")
